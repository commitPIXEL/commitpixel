# Project Software Version

| Skill        | Version |
| ------------ | ------- |
| Java         | 17      |
| SpringBoot   | 3.1.4   |
| MySQL        | 8.0.34  |
| Node.js      | 18.17.1 |
| npm          | 9.6.7   |
| TypeScript   | 4.9.5   |
| React        | 18.2.0  |
| React Router | 6.15.0  |
| React Query  | 4.3.0   |
| React Helmet | 6.1.0   |
| axios        | 1.5.0   |
| Tailwind CSS | 3.3.3   |
| MUI          | 5.14.14 |
| apexcharts   | 3.42.0  |

`ì£¼ì˜ ì‚¬í•­`

Spring BootëŠ” Java 17 ì´ìƒì˜ ë²„ì „ì„ ìš”êµ¬í•œë‹¤.

Jenkinsì—ëŠ” ì´ˆê¸°ì— ì„¤ì •í•œ Javaì˜ ë²„ì „ì— ì˜ì¡´ì ì´ë¯€ë¡œ, í”„ë¡œì íŠ¸ì— ë§ëŠ” Java ë²„ì „ì„ ì´ìš©í•œ Jenkinsë¡œ ì„¤ì¹˜í•  ê²ƒì„ ê¶Œì¥í•œë‹¤.
Jenkins ì„¤ì¹˜ ì™„ë£Œ í›„ì—ë„ Java ë²„ì „ì„ ì„¸íŒ…í•˜ëŠ” ê²ƒì€ ê°€ëŠ¥í•˜ë‹¤.
Jenkinsë¥¼ Dockerë¡œ ê´€ë¦¬í•œë‹¤ë©´, ê¸°ë°˜ì´ ë˜ëŠ” java ë¹Œë” ë²„ì „ì„ ì˜ í™•ì¸í•´ì•¼ í•œë‹¤.

# EC2 í¬íŠ¸ë²ˆí˜¸

MSA í”„ë¡œì íŠ¸, Developê³¼ Release ë²„ì „ì˜ ë¶„ë¦¬ë¡œ ë§ì€ í¬íŠ¸ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤.
Main EC2ì—ëŠ” Backend, Frontendì™€ ê°™ì´ ë©”ì¸ ê¸°ëŠ¥ì„ í¬í•¨í•˜ê³ ,
Sub EC2ì—ëŠ” Redis, monitoring ë„êµ¬ë¥¼ í¬í•¨í•œë‹¤.

## Main EC2

ê¸°ë³¸ì ìœ¼ë¡œ Develop ë²„ì „ì€ Release ë²„ì „ì˜ í¬íŠ¸ë²ˆí˜¸ì— 100ì„ ë”í•˜ëŠ” ê²ƒìœ¼ë¡œ í•˜ì˜€ë‹¤.<br>
í•˜ì§€ë§Œ, SSAFYì˜ í—ˆìš©ëœ í¬íŠ¸ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì˜ˆì™¸ë„ ìˆë‹¤.<br>
**â€» MSëŠ”, MSAë¡œ êµ¬ë¶„ëœ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ í”„ë¡œì íŠ¸ë¥¼ ëœ»í•œë‹¤.**
|Skill|Port|
|--|--|
|Jenkins|8094|

### Develop ë²„ì „

| Skill        | Port |
| ------------ | ---- |
| frontend     | 3100 |
| eureka       | 8861 |
| api gateway  | 8100 |
| cloud config | 8180 |
| authMS       | 8181 |
| userMS       | 8182 |
| pixelMS      | 8183 |
| rankMS       | 8184 |
| imageMS      | 8185 |
| zookeeper1   | 2281 |
| zookeeper2   | 2282 |
| zookeeper3   | 2283 |
| kafka1       | 8992 |
| kafka2       | 8993 |
| kafka3       | 8994 |
| kafka ui     | 8900 |

### Release ë²„ì „

| Skill        | Port  |
| ------------ | ----- |
| frontend     | 3000  |
| eureka       | 8761  |
| api gateway  | 8000  |
| cloud config | 8080  |
| authMS       | 8081  |
| userMS       | 8082  |
| pixelMS      | 8083  |
| rankMS       | 8084  |
| imageMS      | 8085  |
| zookeeper1   | 2181  |
| zookeeper2   | 2182  |
| zookeeper3   | 2183  |
| kafka1       | 9092  |
| kafka2       | 9093  |
| kafka3       | 9094  |
| kafka ui     | 10000 |

## Sub EC2

redisëŠ” ê° MSë³„ë¡œ êµ¬ë¶„í•˜ì˜€ë‹¤. <br>
pixel redisëŠ” íŠ¹íˆ ë°ì´í„°ê°€ ì¤‘ìš”í•˜ë¯€ë¡œ master-slave êµ¬ì¡°ë¥¼ ì±„íƒí•˜ì˜€ê³ , redis-sentinelì„ ì‚¬ìš©í•˜ì˜€ë‹¤. <br>
**â€» redisì™€ MSëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í¬íŠ¸ë¥¼ ë§ì¶”ì§€ë§Œ rankì™€ imageê°€ ë°”ë€Œì–´ìˆë‹¤.**
|Skill|Port|
|--|--|
|redis-auth_dev|8101|
|redis-user_dev|8102|
|redis-pixel-master_dev|8103|
|redis-pixel-slave_dev|8113|
|redis-sentinel1_dev|8123|
|redis-sentinel1_dev|8124|
|redis-sentinel1_dev|8125|
|redis-image_dev|8104|
|redis-rank_dev|8105|
|redis-rank_dev|8105|
|redis-rank_dev|8105|
|redis-auth|8001|
|redis-user|8002|
|redis-pixel-master|8003|
|redis-pixel-slave|8013|
|redis-sentinel1|8023|
|redis-sentinel1|8024|
|redis-sentinel1|8025|
|redis-image|8004|
|redis-rank|8005|
|prometheus|9090|
|grafana|3000|
|nginx_exporter|8913|

<br><br>

# 1. Server êµ¬ì¶•

### EC2

MobaXterm ì„ ì´ìš©í•´ì„œ ì ‘ì† ê°€ëŠ¥<br>
ssh, sftp ëª¨ë‘ ê°€ëŠ¥í•´ì„œ í¸ë¦¬<br>
terminal(ë˜ëŠ” cmd)ì´ìš©<br>
ssh -i {pem_key_file} {ê³„ì •ëª…(ëŒ€ì²´ë¡œ unbuntu)}@{public_IP_address}<br>
FTPëŠ” FileZilla, sshëŠ” Puttyë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, MobaXtermì€ ì´ ë‘ ê°€ì§€ ê¸°ëŠ¥ì„ ëª¨ë‘ í¬í•¨
<br><br>

# Setting Files

**/var/jenkins_home/util/** ê²½ë¡œì— /back, /back_dev, /front_dev ê´€ë¦¬ <br>
docker-compose.yml ê°ê°ì— í•„ìš”í•œ íŒŒì¼ì„ ì €ì¥<br>
nginxëŠ” EC2ì„œë²„ì— ì§ì ‘ ì„¤ì¹˜

**Docker-compose**

Docker composeë¥¼ ì´ìš©í•´ì„œ ì„œë²„ì˜ êµ¬ì„± ìš”ì†Œ(Jenkins, redis)ì˜ imageë¥¼ í•œêº¼ë²ˆì— containerë¥¼ ë§Œë“¤ì–´ì„œ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìˆìŒ

> /var/jenkins_home/util/docker-compose.yml

```yml
version: "3.9"

networks:
  dev:
    driver: bridge
  release:
    driver: bridge

services:
  jenkins:
    image: jenkins/jenkins:jdk17
    container_name: jenkins
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/jenkins_home:/var/jenkins_home
    ports:
      - 8094:8080
    privileged: true
    user: root
    restart: unless-stopped
```

> /var/jenkins_home/util/docker-compose-kafka-release.yml

```yml
version: "3.9"
services:
  zk1:
    container_name: zookeeper1
    image: wurstmeister/zookeeper:latest
    restart: always
    hostname: zk1
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
      TZ: Asia/Seoul
    volumes:
      - "~/zk-cluster/zk1/data:/data"
    networks:
      - release

  zk2:
    container_name: zookeeper2
    image: wurstmeister/zookeeper:latest
    restart: always
    hostname: zk2
    ports:
      - "2182:2181"
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
      TZ: Asia/Seoul
    volumes:
      - "~/zk-cluster/zk2/data:/data"
    networks:
      - release
  zk3:
    container_name: zookeeper3
    image: wurstmeister/zookeeper:latest
    restart: always
    hostname: zk3
    ports:
      - "2183:2181"
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
      TZ: Asia/Seoul
    volumes:
      - "~/zk-cluster/zk3/data:/data"
    networks:
      - release
  kafka1:
    container_name: kafka1
    image: wurstmeister/kafka:latest
    restart: on-failure
    depends_on:
      - zk1
      - zk2
      - zk3
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://k9a709.p.ssafy.io:9092
      KAFKA_LISTENERS: PLAINTEXT://:9092
      BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_ZOOKEEPER_CONNECT: "zk1:2181,zk2:2182,zk3:2183"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      TZ: Asia/Seoul
    networks:
      - release
  kafka2:
    container_name: kafka2
    image: wurstmeister/kafka:latest
    restart: on-failure
    depends_on:
      - zk1
      - zk2
      - zk3
    ports:
      - "9093:9092"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://k9a709.p.ssafy.io:9093
      KAFKA_BROKER_ID: 2
      BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_ZOOKEEPER_CONNECT: "zk1:2181,zk2:2182,zk3:2183"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      TZ: Asia/Seoul
    networks:
      - release
  kafka3:
    container_name: kafka3
    image: wurstmeister/kafka:latest
    restart: on-failure
    depends_on:
      - zk1
      - zk2
      - zk3
    ports:
      - "9094:9092"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://k9a709.p.ssafy.io:9094
      KAFKA_LISTENERS: PLAINTEXT://:9092
      BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_ZOOKEEPER_CONNECT: "zk1:2181,zk2:2182,zk3:2183"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      TZ: Asia/Seoul
    networks:
      - release
  kafka-ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    restart: always
    ports:
      - "10000:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: "commitpixel"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka1:9092,kafka2:9092,kafka3:9092"
      KAFKA_CLUSTERS_0_ZOOKEEPER: "zk1:2181,zk2:2182,zk3:2183"
      AUTH_TYPE: "LOGIN_FORM"
      SPRING_SECURITY_USER_NAME: a709
      SPRING_SECURITY_USER_PASSWORD: rlagmlwhqkqh!!709
      TZ: Asia/Seoul
    networks:
      - release
networks:
  release:
    external: true
```

# Setting Files (Redis ì„¤ì •ì„ ìœ„í•œ EC2)
**Docker-compose**
> /var/jenkins_home/util/docker-compose.yml
```yml
version: '3.8'

networks:
  release:
    external: true
    
services:
  redis-auth:
    image: redis
    container_name: redis-auth
    user: root
    networks:
      - release
    ports:
      - 8001:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-auth-data:/data
    restart: unless-stopped
    
  redis-user:
    image: redis
    container_name: redis-user
    user: root
    networks:
      - release
    ports:
      - 8002:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-user-data:/data
    restart: unless-stopped

  redis-pixel-master:
    image: redis
    container_name: redis-pixel-master
    user: root
    networks:
      - release
    ports:
      - 8003:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 1000 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-pixel-master-data:/data
    restart: unless-stopped
  
  redis-pixel-slave:
    image: redis
    container_name: redis-pixel-slave
    networks:
      - release
    ports:
      - 8013:6379
    command: redis-server --requirepass {password} --port 6379 --slaveof redis-pixel-master 6379 --masterauth {password}
    environment:
      - REDIS_REPLICATION_MODE=slave
    volumes:
      - /home/ubuntu/redis-pixel-slave-data:/data
    restart: unless-stopped
    
  redis-sentinel:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel1
    networks:
      - release
    depends_on:
      - redis-pixel-master
      - redis-pixel-slave
    environment:
      - REDIS_MASTER_HOST=redis-pixel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_SENTINEL_PORT_NUMBER=26379
    volumes:
      - /home/ubuntu/sentinel.conf:/opt/bitnami/redis-sentinel/conf/sentinel.conf
    ports:
      - 8023:26379
    restart: unless-stopped
  
  redis-sentinel2:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel2
    networks:
      - release
    depends_on:
      - redis-pixel-master
      - redis-pixel-slave
    environment:
      - REDIS_MASTER_HOST=redis-pixel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_SENTINEL_PORT_NUMBER=26379
    volumes:
      - /home/ubuntu/sentinel.conf:/opt/bitnami/redis-sentinel/conf/sentinel.conf
    ports:
      - 8024:26379
    restart: unless-stopped
    
  redis-sentinel3:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel3
    networks:
      - release
    depends_on:
      - redis-pixel-master
      - redis-pixel-slave
    environment:
      - REDIS_MASTER_HOST=redis-pixel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_SENTINEL_PORT_NUMBER=26379
    volumes:
      - /home/ubuntu/sentinel.conf:/opt/bitnami/redis-sentinel/conf/sentinel.conf
    ports:
      - 8025:26379
    restart: unless-stopped
    
  redis-image:
    image: redis
    container_name: redis-image
    user: root
    networks:
      - release
    ports:
      - 8004:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-image-data:/data
    restart: unless-stopped
  
  redis-rank:
    image: redis
    container_name: redis-rank
    user: root
    networks:
      - release
    ports:
      - 8005:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-rank-data:/data
    restart: unless-stopped
    
  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: redis-insight
    networks:
      - release
    ports:
      - 8000:8001
    volumes:
      - /home/ubuntu/redis-insight-data:/db
    user: root
    restart: unless-stopped
```

**sentinel.conf**
```conf
sentinel monitor mymaster redis-pixel-master_dev 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
```

<br><br>

## Back-end

Spring bootë¡œ ì´ë£¨ì–´ì§€ê³ , MSA ì•„í‚¤í…ì²˜ë¥¼ ê°€ì§€ëŠ” ë°±ì—”ë“œì´ë‹¤.

**/var/jenkins_home/util/back** ê²½ë¡œì— application.yml, Dockerfile(ë°±ì—”ë“œ ì´ë¯¸ì§€) ì¡´ì¬<br>
â€» java17ì„ ê¸°ë°˜ìœ¼ë¡œ ë°±ì—”ë“œ ë„ì»¤íŒŒì¼ì„ ìƒì„±í•˜ê¸° ìœ„í•´ java17ì´ ê¸°ë°˜ì¸ ì´ë¯¸ì§€ë¥¼ ë¯¸ë¦¬ ìƒì„±í–ˆë‹¤.

> Dockerfile (ubuntu 20.04 ê¸°ë°˜ java17 ë²„ì „ ì´ë¯¸ì§€)

```Dockerfile
# ê¸°ë°˜ì´ ë˜ëŠ” ì´ë¯¸ì§€ ì§€ì •
FROM ubuntu:20.04

# íŒ¨í‚¤ì§€ ì„¤ì¹˜ì‹œ ëŒ€í™”í˜• ì§ˆì˜ ì‘ë‹µ ë°©ì§€
ENV DEBIAN_FRONTEND=noninteractive

# OpenJDK 17 JDK ì„¤ì¹˜
RUN apt-get update && \
    apt-get install -y --no-install-recommends openjdk-17-jdk && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ìë°” í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:${PATH}"

# ì´ë¯¸ì§€ì— ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤í–‰í•  ëª…ë ¹ì–´ ì„¤ì •
CMD ["jshell"]

```

**ë‹¤ìŒ ì´ë¯¸ì§€ë¥¼ ìƒì„±**
ë‹¤ë¥¸ ê²½ë¡œì™€ ê²¹ì¹˜ì§€ ì•Šê³ , ë‹¤ë¥¸ Dockerfileì´ ì—†ëŠ” ê²½ë¡œì—ì„œ ì§„í–‰í•´ì•¼ í•¨

```bash
cd {ìœ„ì˜ Dockerfileì˜ ê²½ë¡œ}
docker build -t my-openjdk-17-jdk-ubuntu:20.04 .
```

ìœ„ì— ìƒì„±í•œ java17ë²„ì „ ì´ë¯¸ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ back-end Dockerfile <br>
jaríŒŒì¼ë¡œ ìƒì„±í•˜ëŠ” ë‹¨ê³„ì™€ RUNí•˜ëŠ” ë‹¨ê³„ë¡œ êµ¬ë¶„<br>
ë©€í‹°-ìŠ¤í…Œì´ì§€ ë¹Œë“œë¥¼ í†µí•´ ê²°ê³¼ ì´ë¯¸ì§€ì˜ í¬ê¸°ë¥¼ ìµœì†Œí™”

> /var/jenkins_home/util/back/Dockerfile

```Dockerfile
# ìœ„ì—ì„œ ìƒì„±í•œ jdk17ë²„ì „ìœ¼ë¡œ ì½”ë“œë¹Œë“œ
FROM my-openjdk-17-jdk-ubuntu:20.04 AS builder
WORKDIR /app
RUN apt-get update && apt-get install
COPY . .
RUN chmod +x gradlew
RUN ./gradlew build -x test

FROM my-openjdk-17-jdk-ubuntu:20.04
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
ARG APP_PORT=8080
EXPOSE $APP_PORT
CMD ["java", "-Duser.timezone=Asia/Seoul", "-jar", "app.jar"]
```

### Spring Cloud Eureka

Spring Cloud EurekaëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ì˜ ì—­í• ì„ í•œë‹¤. ê°ê°ì˜ ì„œë¹„ìŠ¤ë“¤ì„ Eurekaì— ë“±ë¡í•˜ì—¬ ê° ì„œë¹„ìŠ¤ë“¤ì€ ë„¤íŠ¸ì›Œí¬ ìœ„ì¹˜ì— ê´€ê³„ ì—†ì´ ì„œë¡œë¥¼ ì°¾ì•„ í†µì‹ ì„ í•  ìˆ˜ ìˆë‹¤.

eurekaapplication.yml ì—ì„œëŠ” Eureka ì„œë²„ì˜ í¬íŠ¸, ì„œë¹„ìŠ¤ ì´ë¦„, í´ë¼ì´ì–¸íŠ¸ ë“±ë¡ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê°€ì ¸ì˜¤ê¸° ì„¤ì • ë“±ì„ ì„¤ì •í•œë‹¤.

> /var/jenkins_home/util/back/eurekaapplication.yml

```yml
server:
  port: 8761

spring:
  application:
    name: discoveryservice

eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
    service-url:
      defaultZone: http://{hostname}:8761/eureka
  server:
    enableSelfPreservation: false
  instance:
    leaseRenewalIntervalInSeconds: 30
    leaseExpirationDurationInSeconds: 90
```

### Spring Cloud Gateway

Spring Cloud GatewayëŠ” API ê²Œì´íŠ¸ì›¨ì´ë¡œì¨ ë™ì‘í•˜ë©°, í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì ì ˆí•œ ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ…í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ì´ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ëŠ” ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ë‹¨ì¼ ì§„ì…ì ì„ í†µí•´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

apigatewayapplication.yml ì—ì„œëŠ” Gateway ì„œë¹„ìŠ¤ì˜ í¬íŠ¸, Eureka í´ë¼ì´ì–¸íŠ¸ ì„¤ì •, ê·¸ë¦¬ê³  ë¼ìš°íŒ… ê·œì¹™ë“¤ì„ ì„¤ì •í•œë‹¤.

> /var/jenkins_home/util/back/apigatewayapplication.yml

```yml
server:
  port: 8000

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://{hostname}:8761/eureka

spring:
  application:
    name: apigateway
  cloud:
    gateway:
      routes:
        - id: auth
          uri: http://{hostname}:8081/
          predicates:
            - Path=/auth/**
        - id: user
          uri: http://{hostname}:8082/
          predicates:
            - Path=/user/**
        - id: pixel
          uri: http://{hostname}:8083/
          predicates:
            - Path=/pixel/**
        - id: rank
          uri: http://{hostname}:8084/
          predicates:
            - Path=/rank/**
        - id: image
          uri: http://{hostname}:8085/
          predicates:
            - Path=/image/**
```

### Spring Cloud Config

Spring Cloud ConfigëŠ” ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ì¤‘ì•™í™”ëœ ì„¤ì • ê´€ë¦¬ë¥¼ ì œê³µí•œë‹¤. ì´ë¥¼ í†µí•´ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ì˜ êµ¬ì„± ì •ë³´ë¥¼ ì¤‘ì•™ì—ì„œ ê´€ë¦¬í•˜ê³ , ë³€ê²½ ì‚¬í•­ì„ ì‰½ê²Œ ë°°í¬í•  ìˆ˜ ìˆë‹¤.

cloudconfigapplication.ymlì—ì„œëŠ” Config ì„œë²„ì˜ í¬íŠ¸, ì„œë¹„ìŠ¤ ì´ë¦„, í”„ë¡œíŒŒì¼, ì„¤ì • íŒŒì¼ì˜ ìœ„ì¹˜ ë“±ì„ ì„¤ì •í•œë‹¤.

> /var/jenkins_home/util/back/cloudconfigapplication.yml

```yml
server:
  port: 8080

spring:
  application:
    name: cloudconfig
  profiles:
    active: native
  cloud:
    config:
      server:
        native:
          search-locations: classpath:/config/
```

msaconfig.ymlì„ í†µí•´ ê° ì„œë¹„ìŠ¤ë“¤ì€ í•„ìš”í•œ ì¸ì¦í‚¤ ì •ë³´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ë“±ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

> /var/jenkins_home/util/back/masconfig.yml

```yml
# ê³µí†µ ì„¤ì • application.yml
spring:
  config:
    activate:
      on-profile: default

  jpa:
    hibernate:
      ddl-auto: none
      default_batch_fetch_size: 1000

  datasource:
    url: jdbc:mysql://{rds_address}:3306/commitpixel
    hikari:
      driver-class-name: com.mysql.cj.jdbc.Driver
      username: { mysql_username }
      password: { mysql_password }

  github:
    oauth2:
      client-id: { github_client_id }
      client-secret: { github_client_secret }
      redirect-uri: https://commitpixel.com/login/oauth2/github/callback
      token-uri: https://github.com/login/oauth/access_token
      user-info-uri: https://api.github.com/user

  kafka:
    producer:
      bootstrap-servers: { kafka_producer_servers }
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      bootstrap-servers: { kafka_consumer_servers }
      group-id: user-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://{hostname}:8761/eureka

jwt:
  token:
    secret-key: { jwt_secret_key }
  access-token:
    expire-length: 1800000
  refresh-token:
    expire-length: 1209600000

github:
  url: "https://api.github.com"
  user-info-uri: "https://api.github.com/user"

solvedac:
  auth-url: "https://solved.ac/api/v3/user/show"
  message: "commitpixel.com"

canvas:
  scale: 512

feign:
  url: "https://commitpixel.com/api"
---
# auth ì„œë²„ application.yml
server:
  port: 8081

spring:
  config:
    activate:
      on-profile: auth
  application:
    name: auth

  data:
    redis:
      host: { redis_host }
      port: 8001
      password: { redis_password }

---
# user ì„œë²„ applcation.yml
server:
  port: 8082

spring:
  config:
    activate:
      on-profile: user
  application:
    name: user

  data:
    redis:
      host: { redis_host }
      port: 8002
      password: { redis_password }

---
# pixel ì„œë²„ applcation.yml
server:
  port: 8083

spring:
  config:
    activate:
      on-profile: pixel
  application:
    name: pixel

  data:
    redis:
      host: { redis_host }
      port: 8003
      password: { redis_password }

---
# rank ì„œë²„ applcation.yml
server:
  port: 8084

spring:
  config:
    activate:
      on-profile: rank
  application:
    name: rank

  data:
    redis:
      host: { redis_host }
      port: 8004
      password: { redis_password }
    mongodb:
      uri: { mongodb_uri }
      collection: real_real_final

---
# image ì„œë²„ applcation.yml
server:
  port: 8085

spring:
  config:
    activate:
      on-profile: image
  application:
    name: image

  data:
    redis:
      host: { redis_host }
      port: 8005
      password: { redis_password }

cloud:
  aws:
    s3:
      bucket: commitpixel
    credentials:
      access-key: { s3_access_key }
      secret-key: { s3_secret_key }
    region:
      static: ap-northeast-2
  region:
    auto: false
  stack:
    auto: false
```

### Services

ê°ê°ì˜ ì„œë¹„ìŠ¤ë“¤ì€ ë…ë¦½ëœ ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.
'auth', 'user', 'pixel', 'image', 'rank' ë“±ì˜ ì„œë¹„ìŠ¤ëŠ” ê°ê¸° ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ê°€ì§€ê³  í•¨ê»˜ ì‘ë™í•˜ë©° ì „ì²´ ì‹œìŠ¤í…œì„ êµ¬ì„±í•œë‹¤.

> /var/jenkins_home/util/back/masconfig.yml

```yml
server:
  port: { service_port }

spring:
  application:
    name: msaconfig
  profiles:
    active: default,{service_name}
  config:
    import: "optional:configserver:http://{hostname}:8080"

management:
  endpoints:
    web:
      exposure:
        include: refresh
```

### build.gradle

í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œë¥¼ ìœ„í•œ build.gradle íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

### Spring Colud Eureka

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-server'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Spring Cloud Gateway

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Spring Cloud Config

```gradle
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.1.4'
	id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
	sourceCompatibility = '17'
}

repositories {
	mavenCentral()
}

ext {
	set('springCloudVersion', "2022.0.4")
}

dependencies {
	implementation 'org.springframework.cloud:spring-cloud-config-server'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
	imports {
		mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
	}
}

tasks.named('test') {
	useJUnitPlatform()
}

jar.enabled = false
```

### Auth

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    annotationProcessor 'org.projectlombok:lombok'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'
    implementation 'io.jsonwebtoken:jjwt-api:0.11.2'
    implementation 'io.jsonwebtoken:jjwt-impl:0.11.2'
    implementation 'io.jsonwebtoken:jjwt-jackson:0.11.2'
    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'
    // kafka
    implementation 'org.springframework.kafka:spring-kafka'

    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //spring cloud config ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

jar.enabled = false
```

### User

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    // webclient
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    // json
    implementation 'org.json:json:20230227'
    //redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    //OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'
    // validation
    implementation 'jakarta.validation:jakarta.validation-api:3.0.1'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'
    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    //eurekaclinet ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //spring cloud config ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Pixel

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    annotationProcessor 'org.projectlombok:lombok'

    //socket.io ì˜ì¡´ì„± ì¶”ê°€
    implementation 'com.corundumstudio.socketio:netty-socketio:2.0.3'

    //eurekaclinet ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'

    //OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'

    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    //spring cloud config ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'

}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Image

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'
    implementation group: 'com.amazonaws', name: 'aws-java-sdk-s3', version: '1.12.571'
    // OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'
    implementation group: 'org.imgscalr', name: 'imgscalr-lib', version: '4.2'
    // eureka
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    //spring cloud config ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'

    implementation 'javax.xml.bind:jaxb-api:2.3.1'

}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

jar.enabled = false
```

### Rank

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
//    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'

    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'

    // json
    implementation 'org.json:json:20230227'
    //redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'

    // config
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'

    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    //spring cloud config ì˜ì¡´ì„± ì¶”ê°€
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'

    //mongodb
    implementation 'org.springframework.boot:spring-boot-starter-data-mongodb'
//    // https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync
//    implementation group: 'org.mongodb', name: 'mongodb-driver-sync', version: '4.11.0'

}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

## Front-End

Reactë¡œ ì´ë£¨ì–´ì§„ í”„ë¡ íŠ¸ì—”ë“œ ì…ë‹ˆë‹¤.

**/var/jenkins_home/util/front_dev** ê²½ë¡œì— Dockerfile(í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€), front<br>

## /var/jenkins_home/util/front_dev/Dockerfile

Node.jsë¡œ ì½”ë“œ ë¹Œë“œ ë‹¨ê³„ì™€ nginxë¡œ ì½”ë“œ í˜¸ìŠ¤íŒ… ë‹¨ê³„ë¡œ êµ¬ë¶„ <br>
ë©€í‹°-ìŠ¤í…Œì´ì§€ ë¹Œë“œë¥¼ í†µí•´ ê²°ê³¼ ì´ë¯¸ì§€ì˜ í¬ê¸°ë¥¼ ìµœì†Œí™”

```Docker
# ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ node:18-alpineìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
FROM node:18-alpine AS base

# ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.
FROM base AS deps
# í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
RUN apk add --no-cache libc6-compat git
# ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
WORKDIR /usr/src/app
# package.jsonê³¼ yarn.lockì„ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY package.json ./
# ì˜ì¡´ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
RUN npm install
# ìºì‹œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
RUN rm -rf ./.next/cache
# ì†ŒìŠ¤ ì½”ë“œë¥¼ ë¹Œë“œí•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.
FROM base AS builder
# ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
WORKDIR /usr/src/app
# ì˜ì¡´ì„± íŒŒì¼ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY --from=deps /usr/src/app/node_modules ./node_modules
# í”„ë¡œì íŠ¸ íŒŒì¼ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY . .
# Canvas ì›¹ì†Œì¼“ ì„œë²„ìš© ë¡œì»¬
ENV NEXT_PUBLIC_SOCKET_URL={socket_url}
ENV NEXT_PUBLIC_IMAGE_URL={image_url}
ENV NEXT_PUBLIC_API_URL={api_url}

ENV NEXT_PUBLIC_CLIENT_ID={github_client_id}
ENV NEXT_PUBLIC_CLIENT_PW={gitgub_client_password}
ENV NEXT_PUBLIC_CALLBACK_URL={callback_url}

# Kakao ê³µìœ 
ENV NEXT_PUBLIC_JS_KEY={js_key}
ENV NEXT_PUBLIC_TEMPLATE_ID={template_id}

# Open Graph
ENV NEXT_PUBLIC_SITE_URL={site_url}
# ë¹Œë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
RUN yarn build

# í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.
FROM base AS runner
# ì‘ì—… ë””ë ‰í„°ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
WORKDIR /usr/src/app
# í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
ENV NODE_ENV=production
# ì‹œìŠ¤í…œ ê·¸ë£¹ê³¼ ì‚¬ìš©ìë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
# ë¹Œë“œí•œ íŒŒì¼ì„ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY --from=builder /usr/src/app/public ./public
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.next/static ./.next/static
# nextjs ì‚¬ìš©ìë¡œ ì „í™˜í•©ë‹ˆë‹¤.
USER nextjs
# í¬íŠ¸ë¥¼ ì—´ì–´ì¤ë‹ˆë‹¤.
EXPOSE 3000
# í¬íŠ¸ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
ENV PORT 3000
# ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
CMD ["node", "server.js"]
```

## Nginx ì„¤ì¹˜

NginxëŠ” dockerê°€ ì•„ë‹Œ EC2 ë‚´ë¶€ì— ì§ì ‘ ì„¤ì¹˜í–ˆë‹¤.<br>
dockerì˜ ì˜¤ë²„í—¤ë“œê°€ ì—†ê³ , ì„¤ì •ì„ ì§ì ‘ ê´€ë¦¬í•˜ê³  ì¡°ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸<br>
ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ ì„¤ì¹˜í•œë‹¤.

```bash
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install nginx
```

22, 80, 443 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì—´ë¦¬ì§€ ì•Šì€ í¬íŠ¸ê°€ ìˆë‹¤ë©´ ì—´ì–´ì¤€ë‹¤

```bash
sudo ufw allow {port_num}
sudo ufw status # ì—´ë¦° í¬íŠ¸ í™•ì¸
```

ê·¸ë¦¬ê³  ì„¤ì • íŒŒì¼ì„ ìƒì„±í•œë‹¤.

```bash
cd /etc/nginx/conf.d
sudo vim default.conf
```

> /etc/nginx/conf.d/default.conf

```docker
upstream front-dev {
    server localhost:3100;
}

upstream frontend {
    server localhost:3000;
}

upstream back-dev {
    server localhost:8100;
}

upstream backend {
    server localhost:8000;
}

server {
    server_name commitpixel.com;

    location /api {
        rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
    }

    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;

    }
    
        location /socket.io/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;

        proxy_pass http://localhost:3001;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
       
         #504
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
    }

    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/commitpixel.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/commitpixel.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    server_name dev.commitpixel.com;

    location /api {
        rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://back-dev;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
    }

    location / {
        proxy_pass http://front-dev;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
       
         #504
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

    }
    
    location /socket.io/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;

        proxy_pass http://localhost:3101;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
       
         #504
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
    }

    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/commitpixel.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/commitpixel.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}


server {
    if ($host = commitpixel.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot
    
    if ($host = www.commitpixel.com) {
        return 301 https://$host$request_uri;
    }

    if ($host = k9a709.p.ssafy.io) {
        return 301 https://commitpixel.com$request_uri;
    }

    listen 80;
    server_name commitpixel.com k9a709.p.ssafy.io;
    return 404; # managed by Certbot
}

server {
    if ($host = dev.commitpixel.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name dev.commitpixel.com dev.k9a709.p.ssafy.io;
    return 404; # managed by Certbot
}

server {
    if ($host = k9a709.p.ssafy.io) {
        return 301 https://commitpixel.com$request_uri;
    }

    listen 443 ssl;
}

server {
    listen 80;
    server_name 3.38.210.9;

    location /nginx_status {
        stub_status on;
        allow 43.201.19.184; # prometheus EC2 address
        deny all;
    }
}


```

`ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ Certbotìœ¼ë¡œ https ì¸ì¦ í‚¤ë¥¼ ë°›ì•„ì•¼ í•œë‹¤.`

```
# snapì„ ì´ìš©í•˜ì—¬ core ì„¤ì¹˜ -> snapì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ìœ ì§€í•˜ê¸° ìœ„í•´ ì„¤ì¹˜
$ sudo snap install core

# coreë¥¼ refresh í•´ì¤€ë‹¤.
$ sudo snap refresh core

# ê¸°ì¡´ì— ì˜ëª»ëœ certbotì´ ì„¤ì¹˜ë˜ì–´ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì‚­ì œ í•´ì¤€ë‹¤.
$ sudo apt remove certbot

# certbot ì„¤ì¹˜
$ sudo snap install --classic certbot

# ì¸ì¦í‚¤ë¥¼ ë°›ì„ ë„ë©”ì¸ì„ ì„ íƒí•œë‹¤.
# ëª¨ë“  ë„ë©”ì¸ì„ ì¸ì¦ë°›ê³  ì‹¶ë‹¤ë©´ ê·¸ëŒ€ë¡œ enter, Yë¥¼ ì…ë ¥í•œë‹¤.
```

| name     | port | location |
| -------- | ---- | -------- |
| frontend | 3000 | /        |
| backend  | 8000 | /api     |

mappingë˜ëŠ” ì£¼ì†ŒëŠ” ìœ„ì˜ í‘œì™€ ê°™ë‹¤.
Domainì€ commitpixel.comì´ê³ , www.commitpixel.com, k9a709.p.ssafy.io ëª¨ë‘ httpsë¡œ ìë™ ì—°ê²°ëœë‹¤.

<br><br>

# 2. Jenkins ì„¤ì •

Jenkinsë¥¼ ì´ìš©í•´ì„œ ë¹Œë“œ, docker ì´ë¯¸ì§€ ìƒì„± ë° ë°°í¬ë¥¼ ìë™í™” í•  ìˆ˜ ìˆë‹¤.<br>

## Release

Release pipeline ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

> ì „ëµ

```
# 1. environment release ë¸Œëœì¹˜ë¥¼ hooking í•œë‹¤
# 2. stages
# 2-1. gitlabì—ì„œ releaseì˜ codeë¥¼ workspaceì— copyí•œë‹¤
# 2-2. release ë¹Œë“œì— í•„ìš”í•œ Dockerfileê³¼ application.ymlíŒŒì¼ì„ workspaceì— ë³µì‚¬í•œë‹¤.
# 2-3. ë³µì‚¬ëœ Dockerfileì„ ê¸°ë°˜ìœ¼ë¡œ imageë¥¼ ìƒì„±í•œë‹¤.
# 2-4. ìƒì„±í•œ imageë¥¼ containerë¡œ ë§Œë“¤ì–´ ë°ëª¬ìœ¼ë¡œ ì‹¤í–‰í•œë‹¤.
# 2-5. ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” dockerëŠ” ì •ë¦¬í•œë‹¤.
```

```docker
pipeline {
	agent any

	environment {
		gitlabBranch = "develop/backend"
	}

	stages {

		stage('Clone Repository') {
            steps {
                echo "Branch : ${env.gitlabBranch}"
                echo "Clone repository"
                git branch: "${env.gitlabBranch}", url: "https://lab.ssafy.com/s09-fintech-finance-sub2/S09P22A709", credentialsId: {credentialsId}
            }
        }

        stage("Set environment") {
            steps {
                echo "Copy require file to pipeline folder"
                sh 'cp /var/jenkins_home/util/docker-compose.yml .'
                sh 'cp /var/jenkins_home/util/tootbackend/application.yml ./backend/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/tootbackend/Dockerfile ./backend/'
            }
        }

        stage('Docker build') {
            steps {
                echo "docker build"
                dir('/var/jenkins_home/workspace/tootbackend/backend/') {
                    sh "docker build -t backend:toot ."
                }
            }
            post {
                success {
                    echo "Success to build"
                }
                failure {
                    echo "Docker build failed. clear unused file"
                    sh "docker system prune -f"
                    error 'pipeline aborted'
                }
            }
        }

        stage('Docker up') {
            steps {
                echo "docker up"
                sh 'docker rm -f backend'
                sh "docker run -d --name backend -p 8200:8080 --network util_default -u root backend:toot"
            }
        }

        stage('Docker clear') {
            steps{
                sh "docker system prune -f"
            }
        }

	}
}
```

<br><br>

# ì™¸ë¶€ ì„œë¹„ìŠ¤

#### **AWS RDS**

- **ì„œë¹„ìŠ¤ ì„¤ëª…**: Amazon Relational Database Service(AWS RDS)ëŠ” í´ë¼ìš°ë“œì—ì„œ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‰½ê²Œ ì„¤ì •, ìš´ì˜ ë° í™•ì¥í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤
- **ì£¼ìš” íŠ¹ì§•**:
  - ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ìœ í˜• ì§€ì›
  - ìë™ ë°±ì—…, ì†Œí”„íŠ¸ì›¨ì–´ íŒ¨ì¹˜, ìë™ í™•ì¥ ë“±ì˜ ê¸°ëŠ¥ ì œê³µ
- **ê°€ì… ë°©ë²•**: AWS ê³„ì •ì„ ìƒì„±í•œ í›„, AWS Management Consoleì—ì„œ RDS ì„œë¹„ìŠ¤ë¥¼ ì°¾ì•„ ê°€ì…í•©ë‹ˆë‹¤.
- **ì‚¬ìš© ë°©ë²•**: [AWS RDS Documentation](https://aws.amazon.com/rds/)

#### **AWS S3**

- **ì„œë¹„ìŠ¤ ì„¤ëª…**: Amazon Simple Storage Service(Amazon S3)ëŠ” ì—…ê³„ ìµœê³  ìˆ˜ì¤€ì˜ í™•ì¥ì„±, ë°ì´í„° ê°€ìš©ì„±, ë³´ì•ˆ ë° ì„±ëŠ¥ì„ ì œê³µí•˜ëŠ” ê°ì²´ ìŠ¤í† ë¦¬ì§€ ì„œë¹„ìŠ¤
- **ì£¼ìš” íŠ¹ì§•**:
  - ë†’ì€ ë‚´êµ¬ì„±ê³¼ ê°€ìš©ì„±ì„ ë³´ì¥í•˜ëŠ” ê°ì²´ ì €ì¥ì†Œ
  - ë°ì´í„° ë³´í˜¸ ë° ë³´ì•ˆ ê¸°ëŠ¥
- **ê°€ì… ë°©ë²•**: AWS ê³„ì •ì„ ìƒì„±í•œ í›„, AWS Management Consoleì—ì„œ S3 ì„œë¹„ìŠ¤ë¥¼ ì°¾ì•„ ê°€ì…í•©ë‹ˆë‹¤.
- **ì‚¬ìš© ë°©ë²•**: [AWS S3 Documentation](https://aws.amazon.com/ko/s3/)

#### Atlas MongoDB

- **ì„œë¹„ìŠ¤ ì„¤ëª…**: Atlas MongoDBëŠ” í´ë¼ìš°ë“œ ê¸°ë°˜ì˜ MongoDB ì„œë¹„ìŠ¤ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‰½ê³  ë¹ ë¥´ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•©ë‹ˆë‹¤. í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ MongoDB ì¸ìŠ¤í„´ìŠ¤ë¥¼ í˜¸ìŠ¤íŒ…í•˜ë©°, ìë™í™”ëœ ë°±ì—…, í™•ì¥ì„±, ë³´ì•ˆ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
- **ì£¼ìš” íŠ¹ì§•**:
  - í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œì˜ ìë™í™”ëœ ë°±ì—… ë° ë³µêµ¬ ê¸°ëŠ¥
  - ì‰¬ìš´ í™•ì¥ì„± ë° ê´€ë¦¬ í¸ì˜ì„±
  - ë°ì´í„° ë³´ì•ˆ ë° ì•”í˜¸í™” ì˜µì…˜
- **ê°€ì… ë°©ë²•**: MongoDB ì›¹ì‚¬ì´íŠ¸ì—ì„œ Atlas MongoDB ì„œë¹„ìŠ¤ì— ê°€ì…í•˜ê³ , ê´€ë ¨ ê³„ì •ì„ ì„¤ì •í•©ë‹ˆë‹¤.
- **ì‚¬ìš© ë°©ë²•**: [Atlas MongoDB Documentation](https://www.mongodb.com/docs/atlas/)

#### **GITHUB API**

- **ì„œë¹„ìŠ¤ ì„¤ëª…**: ì‚¬ìš©ìì˜ ìµœê·¼ 7ì¼ê°„ ì»¤ë°‹ê¸°ë¡ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ API
  ì»¤ë°‹ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ í”½ì…€ í¬ë ˆë”§ì„ ì§€ê¸‰í•˜ê¸° ìœ„í•´ ì‚¬ìš©
- **ì‚¬ìš© ë°©ë²•**: [GitHub API Documentation](https://docs.github.com/en/rest?apiVersion=2022-11-28)

#### **SOLVEDAC API**

- **ì„œë¹„ìŠ¤ ì„¤ëª…**: ì‚¬ìš©ìì˜ ë°±ì¤€ í‘¼ ë¬¸ì œìˆ˜ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ API
  í‘¼ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”½ì…€ í¬ë ˆë”§ì„ ì§€ê¸‰í•˜ê¸° ìœ„í•´ ì‚¬ìš©
- **ì‚¬ìš© ë°©ë²•**: [Solvedac Unofficial Documentation](https://solvedac.github.io/unofficial-documentation/#/)


#### Flourish

- **ì„œë¹„ìŠ¤ ì„¤ëª…**: FlourishëŠ” ë°ì´í„° ì‹œê°í™” ë° ì¸í„°ë™í‹°ë¸Œ ìŠ¤í† ë¦¬í…”ë§ì„ ìœ„í•œ ì›¹ ê¸°ë°˜ í”Œë«í¼ì…ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ë³µì¡í•œ ë°ì´í„°ë¥¼ ì‰½ê³  ì§ê´€ì ìœ¼ë¡œ ì‹œê°í™”í•  ìˆ˜ ìˆìœ¼ë©°, ì¸í„°ë™í‹°ë¸Œí•œ ì°¨íŠ¸, ì§€ë„ ë° ë°ì´í„° ìŠ¤í† ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **ì£¼ìš” íŠ¹ì§•**:
  - ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¸í„°í˜ì´ìŠ¤
  - ë‹¤ì–‘í•œ ì‹œê°í™” í…œí”Œë¦¿ê³¼ ì‚¬ìš©ì ì •ì˜ ì˜µì…˜
  - ë°ì´í„°ë¥¼ ì‰½ê²Œ ê°€ì ¸ì˜¤ê³  ë‚´ë³´ë‚¼ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥
- **ê°€ì… ë°©ë²•**: Flourish ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•˜ì—¬ ê³„ì •ì„ ìƒì„±í•˜ê³ , ê°€ì… ì ˆì°¨ë¥¼ ì™„ë£Œí•©ë‹ˆë‹¤.
- **ì‚¬ìš© ë°©ë²•**: [Flourish Documentation](https://help.flourish.studio/)

<br><br>

# DB ë¤í”„ íŒŒì¼ ìµœì‹ ë³¸

[DB ë¤í”„ íŒŒì¼ ìµœì‹ ë³¸](files/commitPIXEL_db_dump.sql)

<br>

# ê¸°ëŠ¥ ì‹œì—°

[README.md](../README.md#ğŸ’»-ì£¼ìš”-ê¸°ëŠ¥-ë¯¸ë¦¬ë³´ê¸°)
