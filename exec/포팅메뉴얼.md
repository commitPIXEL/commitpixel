# Project Software Version

| Skill        | Version |
| ------------ | ------- |
| Java         | 17      |
| SpringBoot   | 3.1.4   |
| MySQL        | 8.0.34  |
| Node.js      | 18.17.1 |
| npm          | 9.6.7   |
| TypeScript   | 4.9.5   |
| React        | 18.2.0  |
| React Router | 6.15.0  |
| React Query  | 4.3.0   |
| React Helmet | 6.1.0   |
| axios        | 1.5.0   |
| Tailwind CSS | 3.3.3   |
| MUI          | 5.14.14 |
| apexcharts   | 3.42.0  |

`주의 사항`

Spring Boot는 Java 17 이상의 버전을 요구한다.

Jenkins에는 초기에 설정한 Java의 버전에 의존적이므로, 프로젝트에 맞는 Java 버전을 이용한 Jenkins로 설치할 것을 권장한다.
Jenkins 설치 완료 후에도 Java 버전을 세팅하는 것은 가능하다.
Jenkins를 Docker로 관리한다면, 기반이 되는 java 빌더 버전을 잘 확인해야 한다.

# EC2 포트번호

MSA 프로젝트, Develop과 Release 버전의 분리로 많은 포트번호를 사용하고 있다.
Main EC2에는 Backend, Frontend와 같이 메인 기능을 포함하고,
Sub EC2에는 Redis, monitoring 도구를 포함한다.

## Main EC2

기본적으로 Develop 버전은 Release 버전의 포트번호에 100을 더하는 것으로 하였다.<br>
하지만, SSAFY의 허용된 포트번호를 사용하기 위해 예외도 있다.<br>
**※ MS는, MSA로 구분된 마이크로 서비스 프로젝트를 뜻한다.**
|Skill|Port|
|--|--|
|Jenkins|8094|

### Develop 버전

| Skill        | Port |
| ------------ | ---- |
| frontend     | 3100 |
| eureka       | 8861 |
| api gateway  | 8100 |
| cloud config | 8180 |
| authMS       | 8181 |
| userMS       | 8182 |
| pixelMS      | 8183 |
| rankMS       | 8184 |
| imageMS      | 8185 |
| zookeeper1   | 2281 |
| zookeeper2   | 2282 |
| zookeeper3   | 2283 |
| kafka1       | 8992 |
| kafka2       | 8993 |
| kafka3       | 8994 |
| kafka ui     | 8900 |

### Release 버전

| Skill        | Port  |
| ------------ | ----- |
| frontend     | 3000  |
| eureka       | 8761  |
| api gateway  | 8000  |
| cloud config | 8080  |
| authMS       | 8081  |
| userMS       | 8082  |
| pixelMS      | 8083  |
| rankMS       | 8084  |
| imageMS      | 8085  |
| zookeeper1   | 2181  |
| zookeeper2   | 2182  |
| zookeeper3   | 2183  |
| kafka1       | 9092  |
| kafka2       | 9093  |
| kafka3       | 9094  |
| kafka ui     | 10000 |

## Sub EC2

redis는 각 MS별로 구분하였다. <br>
pixel redis는 특히 데이터가 중요하므로 master-slave 구조를 채택하였고, redis-sentinel을 사용하였다. <br>
**※ redis와 MS는 기본적으로 포트를 맞추지만 rank와 image가 바뀌어있다.**
|Skill|Port|
|--|--|
|redis-auth_dev|8101|
|redis-user_dev|8102|
|redis-pixel-master_dev|8103|
|redis-pixel-slave_dev|8113|
|redis-sentinel1_dev|8123|
|redis-sentinel1_dev|8124|
|redis-sentinel1_dev|8125|
|redis-image_dev|8104|
|redis-rank_dev|8105|
|redis-rank_dev|8105|
|redis-rank_dev|8105|
|redis-auth|8001|
|redis-user|8002|
|redis-pixel-master|8003|
|redis-pixel-slave|8013|
|redis-sentinel1|8023|
|redis-sentinel1|8024|
|redis-sentinel1|8025|
|redis-image|8004|
|redis-rank|8005|
|prometheus|9090|
|grafana|3000|
|nginx_exporter|8913|

<br><br>

# 1. Server 구축

### EC2

MobaXterm 을 이용해서 접속 가능<br>
ssh, sftp 모두 가능해서 편리<br>
terminal(또는 cmd)이용<br>
ssh -i {pem_key_file} {계정명(대체로 unbuntu)}@{public_IP_address}<br>
FTP는 FileZilla, ssh는 Putty를 사용할 수 있지만, MobaXterm은 이 두 가지 기능을 모두 포함
<br><br>

# Setting Files

**/var/jenkins_home/util/** 경로에 /back, /back_dev, /front_dev 관리 <br>
docker-compose.yml 각각에 필요한 파일을 저장<br>
nginx는 EC2서버에 직접 설치

**Docker-compose**

Docker compose를 이용해서 서버의 구성 요소(Jenkins, redis)의 image를 한꺼번에 container를 만들어서 실행시킬 수 있음

> /var/jenkins_home/util/docker-compose.yml

```yml
version: "3.9"

networks:
  dev:
    driver: bridge
  release:
    driver: bridge

services:
  jenkins:
    image: jenkins/jenkins:jdk17
    container_name: jenkins
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/jenkins_home:/var/jenkins_home
    ports:
      - 8094:8080
    privileged: true
    user: root
    restart: unless-stopped
```

> /var/jenkins_home/util/docker-compose-kafka-release.yml

```yml
version: "3.9"
services:
  zk1:
    container_name: zookeeper1
    image: wurstmeister/zookeeper:latest
    restart: always
    hostname: zk1
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
      TZ: Asia/Seoul
    volumes:
      - "~/zk-cluster/zk1/data:/data"
    networks:
      - release

  zk2:
    container_name: zookeeper2
    image: wurstmeister/zookeeper:latest
    restart: always
    hostname: zk2
    ports:
      - "2182:2181"
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
      TZ: Asia/Seoul
    volumes:
      - "~/zk-cluster/zk2/data:/data"
    networks:
      - release
  zk3:
    container_name: zookeeper3
    image: wurstmeister/zookeeper:latest
    restart: always
    hostname: zk3
    ports:
      - "2183:2181"
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zk1:2888:3888;2181 server.2=zk2:2888:3888;2181 server.3=zk3:2888:3888;2181
      TZ: Asia/Seoul
    volumes:
      - "~/zk-cluster/zk3/data:/data"
    networks:
      - release
  kafka1:
    container_name: kafka1
    image: wurstmeister/kafka:latest
    restart: on-failure
    depends_on:
      - zk1
      - zk2
      - zk3
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://k9a709.p.ssafy.io:9092
      KAFKA_LISTENERS: PLAINTEXT://:9092
      BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_ZOOKEEPER_CONNECT: "zk1:2181,zk2:2182,zk3:2183"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      TZ: Asia/Seoul
    networks:
      - release
  kafka2:
    container_name: kafka2
    image: wurstmeister/kafka:latest
    restart: on-failure
    depends_on:
      - zk1
      - zk2
      - zk3
    ports:
      - "9093:9092"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      KAFKA_LISTENERS: PLAINTEXT://:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://k9a709.p.ssafy.io:9093
      KAFKA_BROKER_ID: 2
      BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_ZOOKEEPER_CONNECT: "zk1:2181,zk2:2182,zk3:2183"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      TZ: Asia/Seoul
    networks:
      - release
  kafka3:
    container_name: kafka3
    image: wurstmeister/kafka:latest
    restart: on-failure
    depends_on:
      - zk1
      - zk2
      - zk3
    ports:
      - "9094:9092"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://k9a709.p.ssafy.io:9094
      KAFKA_LISTENERS: PLAINTEXT://:9092
      BOOTSTRAP_SERVERS: kafka1:9092,kafka2:9092,kafka3:9092
      KAFKA_ZOOKEEPER_CONNECT: "zk1:2181,zk2:2182,zk3:2183"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2
      TZ: Asia/Seoul
    networks:
      - release
  kafka-ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    restart: always
    ports:
      - "10000:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: "commitpixel"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka1:9092,kafka2:9092,kafka3:9092"
      KAFKA_CLUSTERS_0_ZOOKEEPER: "zk1:2181,zk2:2182,zk3:2183"
      AUTH_TYPE: "LOGIN_FORM"
      SPRING_SECURITY_USER_NAME: a709
      SPRING_SECURITY_USER_PASSWORD: rlagmlwhqkqh!!709
      TZ: Asia/Seoul
    networks:
      - release
networks:
  release:
    external: true
```

# Setting Files (Redis 설정을 위한 EC2)
**Docker-compose**
> /var/jenkins_home/util/docker-compose.yml
```yml
version: '3.8'

networks:
  release:
    external: true
    
services:
  redis-auth:
    image: redis
    container_name: redis-auth
    user: root
    networks:
      - release
    ports:
      - 8001:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-auth-data:/data
    restart: unless-stopped
    
  redis-user:
    image: redis
    container_name: redis-user
    user: root
    networks:
      - release
    ports:
      - 8002:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-user-data:/data
    restart: unless-stopped

  redis-pixel-master:
    image: redis
    container_name: redis-pixel-master
    user: root
    networks:
      - release
    ports:
      - 8003:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 1000 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-pixel-master-data:/data
    restart: unless-stopped
  
  redis-pixel-slave:
    image: redis
    container_name: redis-pixel-slave
    networks:
      - release
    ports:
      - 8013:6379
    command: redis-server --requirepass {password} --port 6379 --slaveof redis-pixel-master 6379 --masterauth {password}
    environment:
      - REDIS_REPLICATION_MODE=slave
    volumes:
      - /home/ubuntu/redis-pixel-slave-data:/data
    restart: unless-stopped
    
  redis-sentinel:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel1
    networks:
      - release
    depends_on:
      - redis-pixel-master
      - redis-pixel-slave
    environment:
      - REDIS_MASTER_HOST=redis-pixel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_SENTINEL_PORT_NUMBER=26379
    volumes:
      - /home/ubuntu/sentinel.conf:/opt/bitnami/redis-sentinel/conf/sentinel.conf
    ports:
      - 8023:26379
    restart: unless-stopped
  
  redis-sentinel2:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel2
    networks:
      - release
    depends_on:
      - redis-pixel-master
      - redis-pixel-slave
    environment:
      - REDIS_MASTER_HOST=redis-pixel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_SENTINEL_PORT_NUMBER=26379
    volumes:
      - /home/ubuntu/sentinel.conf:/opt/bitnami/redis-sentinel/conf/sentinel.conf
    ports:
      - 8024:26379
    restart: unless-stopped
    
  redis-sentinel3:
    image: bitnami/redis-sentinel:latest
    container_name: redis-sentinel3
    networks:
      - release
    depends_on:
      - redis-pixel-master
      - redis-pixel-slave
    environment:
      - REDIS_MASTER_HOST=redis-pixel-master
      - REDIS_MASTER_PORT_NUMBER=6379
      - REDIS_SENTINEL_PORT_NUMBER=26379
    volumes:
      - /home/ubuntu/sentinel.conf:/opt/bitnami/redis-sentinel/conf/sentinel.conf
    ports:
      - 8025:26379
    restart: unless-stopped
    
  redis-image:
    image: redis
    container_name: redis-image
    user: root
    networks:
      - release
    ports:
      - 8004:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-image-data:/data
    restart: unless-stopped
  
  redis-rank:
    image: redis
    container_name: redis-rank
    user: root
    networks:
      - release
    ports:
      - 8005:6379
    command: redis-server --requirepass {password} --port 6379 --save 60 100 --dir /data --dbfilename dump.rdb
    environment:
      - REDIS_REPLICATION_MODE=master
    volumes:
      - /home/ubuntu/redis-rank-data:/data
    restart: unless-stopped
    
  redis-insight:
    image: redislabs/redisinsight:latest
    container_name: redis-insight
    networks:
      - release
    ports:
      - 8000:8001
    volumes:
      - /home/ubuntu/redis-insight-data:/db
    user: root
    restart: unless-stopped
```

**sentinel.conf**
```conf
sentinel monitor mymaster redis-pixel-master_dev 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
sentinel parallel-syncs mymaster 1
```

<br><br>

## Back-end

Spring boot로 이루어지고, MSA 아키텍처를 가지는 백엔드이다.

**/var/jenkins_home/util/back** 경로에 application.yml, Dockerfile(백엔드 이미지) 존재<br>
※ java17을 기반으로 백엔드 도커파일을 생성하기 위해 java17이 기반인 이미지를 미리 생성했다.

> Dockerfile (ubuntu 20.04 기반 java17 버전 이미지)

```Dockerfile
# 기반이 되는 이미지 지정
FROM ubuntu:20.04

# 패키지 설치시 대화형 질의 응답 방지
ENV DEBIAN_FRONTEND=noninteractive

# OpenJDK 17 JDK 설치
RUN apt-get update && \
    apt-get install -y --no-install-recommends openjdk-17-jdk && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 자바 환경변수 설정
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="$JAVA_HOME/bin:${PATH}"

# 이미지에 기본적으로 실행할 명령어 설정
CMD ["jshell"]

```

**다음 이미지를 생성**
다른 경로와 겹치지 않고, 다른 Dockerfile이 없는 경로에서 진행해야 함

```bash
cd {위의 Dockerfile의 경로}
docker build -t my-openjdk-17-jdk-ubuntu:20.04 .
```

위에 생성한 java17버전 이미지를 기반으로 한 back-end Dockerfile <br>
jar파일로 생성하는 단계와 RUN하는 단계로 구분<br>
멀티-스테이지 빌드를 통해 결과 이미지의 크기를 최소화

> /var/jenkins_home/util/back/Dockerfile

```Dockerfile
# 위에서 생성한 jdk17버전으로 코드빌드
FROM my-openjdk-17-jdk-ubuntu:20.04 AS builder
WORKDIR /app
RUN apt-get update && apt-get install
COPY . .
RUN chmod +x gradlew
RUN ./gradlew build -x test

FROM my-openjdk-17-jdk-ubuntu:20.04
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
ARG APP_PORT=8080
EXPOSE $APP_PORT
CMD ["java", "-Duser.timezone=Asia/Seoul", "-jar", "app.jar"]
```

### Spring Cloud Eureka

Spring Cloud Eureka는 마이크로서비스 아키텍처에서 서비스 디스커버리의 역할을 한다. 각각의 서비스들을 Eureka에 등록하여 각 서비스들은 네트워크 위치에 관계 없이 서로를 찾아 통신을 할 수 있다.

eurekaapplication.yml 에서는 Eureka 서버의 포트, 서비스 이름, 클라이언트 등록 및 레지스트리 가져오기 설정 등을 설정한다.

> /var/jenkins_home/util/back/eurekaapplication.yml

```yml
server:
  port: 8761

spring:
  application:
    name: discoveryservice

eureka:
  client:
    register-with-eureka: false
    fetch-registry: false
    service-url:
      defaultZone: http://{hostname}:8761/eureka
  server:
    enableSelfPreservation: false
  instance:
    leaseRenewalIntervalInSeconds: 30
    leaseExpirationDurationInSeconds: 90
```

### Spring Cloud Gateway

Spring Cloud Gateway는 API 게이트웨이로써 동작하며, 클라이언트의 요청을 적절한 서비스로 라우팅하는 역할을 한다. 이를 통해 클라이언트는 마이크로 서비스 아키텍처에서 단일 진입점을 통해 서비스를 이용할 수 있다.

apigatewayapplication.yml 에서는 Gateway 서비스의 포트, Eureka 클라이언트 설정, 그리고 라우팅 규칙들을 설정한다.

> /var/jenkins_home/util/back/apigatewayapplication.yml

```yml
server:
  port: 8000

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://{hostname}:8761/eureka

spring:
  application:
    name: apigateway
  cloud:
    gateway:
      routes:
        - id: auth
          uri: http://{hostname}:8081/
          predicates:
            - Path=/auth/**
        - id: user
          uri: http://{hostname}:8082/
          predicates:
            - Path=/user/**
        - id: pixel
          uri: http://{hostname}:8083/
          predicates:
            - Path=/pixel/**
        - id: rank
          uri: http://{hostname}:8084/
          predicates:
            - Path=/rank/**
        - id: image
          uri: http://{hostname}:8085/
          predicates:
            - Path=/image/**
```

### Spring Cloud Config

Spring Cloud Config는 마이크로서비스 아키텍처에서 중앙화된 설정 관리를 제공한다. 이를 통해 여러 서비스의 구성 정보를 중앙에서 관리하고, 변경 사항을 쉽게 배포할 수 있다.

cloudconfigapplication.yml에서는 Config 서버의 포트, 서비스 이름, 프로파일, 설정 파일의 위치 등을 설정한다.

> /var/jenkins_home/util/back/cloudconfigapplication.yml

```yml
server:
  port: 8080

spring:
  application:
    name: cloudconfig
  profiles:
    active: native
  cloud:
    config:
      server:
        native:
          search-locations: classpath:/config/
```

msaconfig.yml을 통해 각 서비스들은 필요한 인증키 정보나 데이터베이스 설정 등을 가져올 수 있다.

> /var/jenkins_home/util/back/masconfig.yml

```yml
# 공통 설정 application.yml
spring:
  config:
    activate:
      on-profile: default

  jpa:
    hibernate:
      ddl-auto: none
      default_batch_fetch_size: 1000

  datasource:
    url: jdbc:mysql://{rds_address}:3306/commitpixel
    hikari:
      driver-class-name: com.mysql.cj.jdbc.Driver
      username: { mysql_username }
      password: { mysql_password }

  github:
    oauth2:
      client-id: { github_client_id }
      client-secret: { github_client_secret }
      redirect-uri: https://commitpixel.com/login/oauth2/github/callback
      token-uri: https://github.com/login/oauth/access_token
      user-info-uri: https://api.github.com/user

  kafka:
    producer:
      bootstrap-servers: { kafka_producer_servers }
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      bootstrap-servers: { kafka_consumer_servers }
      group-id: user-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://{hostname}:8761/eureka

jwt:
  token:
    secret-key: { jwt_secret_key }
  access-token:
    expire-length: 1800000
  refresh-token:
    expire-length: 1209600000

github:
  url: "https://api.github.com"
  user-info-uri: "https://api.github.com/user"

solvedac:
  auth-url: "https://solved.ac/api/v3/user/show"
  message: "commitpixel.com"

canvas:
  scale: 512

feign:
  url: "https://commitpixel.com/api"
---
# auth 서버 application.yml
server:
  port: 8081

spring:
  config:
    activate:
      on-profile: auth
  application:
    name: auth

  data:
    redis:
      host: { redis_host }
      port: 8001
      password: { redis_password }

---
# user 서버 applcation.yml
server:
  port: 8082

spring:
  config:
    activate:
      on-profile: user
  application:
    name: user

  data:
    redis:
      host: { redis_host }
      port: 8002
      password: { redis_password }

---
# pixel 서버 applcation.yml
server:
  port: 8083

spring:
  config:
    activate:
      on-profile: pixel
  application:
    name: pixel

  data:
    redis:
      host: { redis_host }
      port: 8003
      password: { redis_password }

---
# rank 서버 applcation.yml
server:
  port: 8084

spring:
  config:
    activate:
      on-profile: rank
  application:
    name: rank

  data:
    redis:
      host: { redis_host }
      port: 8004
      password: { redis_password }
    mongodb:
      uri: { mongodb_uri }
      collection: real_real_final

---
# image 서버 applcation.yml
server:
  port: 8085

spring:
  config:
    activate:
      on-profile: image
  application:
    name: image

  data:
    redis:
      host: { redis_host }
      port: 8005
      password: { redis_password }

cloud:
  aws:
    s3:
      bucket: commitpixel
    credentials:
      access-key: { s3_access_key }
      secret-key: { s3_secret_key }
    region:
      static: ap-northeast-2
  region:
    auto: false
  stack:
    auto: false
```

### Services

각각의 서비스들은 독립된 역할을 수행한다.
'auth', 'user', 'pixel', 'image', 'rank' 등의 서비스는 각기 다른 기능을 가지고 함께 작동하며 전체 시스템을 구성한다.

> /var/jenkins_home/util/back/masconfig.yml

```yml
server:
  port: { service_port }

spring:
  application:
    name: msaconfig
  profiles:
    active: default,{service_name}
  config:
    import: "optional:configserver:http://{hostname}:8080"

management:
  endpoints:
    web:
      exposure:
        include: refresh
```

### build.gradle

프로젝트를 빌드를 위한 build.gradle 파일은 다음과 같다.

### Spring Colud Eureka

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-server'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Spring Cloud Gateway

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.cloud:spring-cloud-starter-gateway'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Spring Cloud Config

```gradle
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.1.4'
	id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
	sourceCompatibility = '17'
}

repositories {
	mavenCentral()
}

ext {
	set('springCloudVersion', "2022.0.4")
}

dependencies {
	implementation 'org.springframework.cloud:spring-cloud-config-server'
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

dependencyManagement {
	imports {
		mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
	}
}

tasks.named('test') {
	useJUnitPlatform()
}

jar.enabled = false
```

### Auth

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    annotationProcessor 'org.projectlombok:lombok'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'
    implementation 'io.jsonwebtoken:jjwt-api:0.11.2'
    implementation 'io.jsonwebtoken:jjwt-impl:0.11.2'
    implementation 'io.jsonwebtoken:jjwt-jackson:0.11.2'
    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'
    // kafka
    implementation 'org.springframework.kafka:spring-kafka'

    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //spring cloud config 의존성 추가
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

jar.enabled = false
```

### User

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    // webclient
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    // json
    implementation 'org.json:json:20230227'
    //redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    //OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'
    // validation
    implementation 'jakarta.validation:jakarta.validation-api:3.0.1'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'
    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    //eurekaclinet 의존성 추가
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //spring cloud config 의존성 추가
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Pixel

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    annotationProcessor 'org.projectlombok:lombok'

    //socket.io 의존성 추가
    implementation 'com.corundumstudio.socketio:netty-socketio:2.0.3'

    //eurekaclinet 의존성 추가
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'

    //OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'

    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    //spring cloud config 의존성 추가
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'

}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

### Image

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'
    implementation group: 'com.amazonaws', name: 'aws-java-sdk-s3', version: '1.12.571'
    // OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'
    implementation group: 'org.imgscalr', name: 'imgscalr-lib', version: '4.2'
    // eureka
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    //spring cloud config 의존성 추가
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'

    implementation 'javax.xml.bind:jaxb-api:2.3.1'

}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

jar.enabled = false
```

### Rank

```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'com.ssafy.realrealfinal'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('springCloudVersion', "2022.0.4")
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    developmentOnly 'org.springframework.boot:spring-boot-devtools'
//    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'

    // Mapstruct
    implementation 'org.mapstruct:mapstruct:1.4.2.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.4.2.Final'

    // json
    implementation 'org.json:json:20230227'
    //redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'

    // config
    implementation 'org.springframework.cloud:spring-cloud-starter-netflix-eureka-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    //OpenFeign
    implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.0.3'

    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    // kafka
    implementation 'org.springframework.kafka:spring-kafka'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'

    //spring cloud config 의존성 추가
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.cloud:spring-cloud-config-client'
    implementation 'org.springframework.cloud:spring-cloud-starter-config'

    //mongodb
    implementation 'org.springframework.boot:spring-boot-starter-data-mongodb'
//    // https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync
//    implementation group: 'org.mongodb', name: 'mongodb-driver-sync', version: '4.11.0'

}

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:2022.0.4"
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

jar.enabled = false
```

## Front-End

React로 이루어진 프론트엔드 입니다.

**/var/jenkins_home/util/front_dev** 경로에 Dockerfile(프론트엔드 이미지), front<br>

## /var/jenkins_home/util/front_dev/Dockerfile

Node.js로 코드 빌드 단계와 nginx로 코드 호스팅 단계로 구분 <br>
멀티-스테이지 빌드를 통해 결과 이미지의 크기를 최소화

```Docker
# 기본 이미지를 node:18-alpine으로 설정합니다.
FROM node:18-alpine AS base

# 의존성을 설치하는 단계입니다.
FROM base AS deps
# 필요한 패키지를 설치합니다.
RUN apk add --no-cache libc6-compat git
# 작업 디렉터리를 설정합니다.
WORKDIR /usr/src/app
# package.json과 yarn.lock을 복사합니다.
COPY package.json ./
# 의존성을 설치합니다.
RUN npm install
# 캐시를 삭제합니다.
RUN rm -rf ./.next/cache
# 소스 코드를 빌드하는 단계입니다.
FROM base AS builder
# 작업 디렉터리를 설정합니다.
WORKDIR /usr/src/app
# 의존성 파일을 복사합니다.
COPY --from=deps /usr/src/app/node_modules ./node_modules
# 프로젝트 파일을 복사합니다.
COPY . .
# Canvas 웹소켓 서버용 로컬
ENV NEXT_PUBLIC_SOCKET_URL={socket_url}
ENV NEXT_PUBLIC_IMAGE_URL={image_url}
ENV NEXT_PUBLIC_API_URL={api_url}

ENV NEXT_PUBLIC_CLIENT_ID={github_client_id}
ENV NEXT_PUBLIC_CLIENT_PW={gitgub_client_password}
ENV NEXT_PUBLIC_CALLBACK_URL={callback_url}

# Kakao 공유
ENV NEXT_PUBLIC_JS_KEY={js_key}
ENV NEXT_PUBLIC_TEMPLATE_ID={template_id}

# Open Graph
ENV NEXT_PUBLIC_SITE_URL={site_url}
# 빌드를 실행합니다.
RUN yarn build

# 프로덕션 이미지를 생성하는 단계입니다.
FROM base AS runner
# 작업 디렉터리를 설정합니다.
WORKDIR /usr/src/app
# 환경변수를 설정합니다.
ENV NODE_ENV=production
# 시스템 그룹과 사용자를 추가합니다.
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
# 빌드한 파일을 복사합니다.
COPY --from=builder /usr/src/app/public ./public
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /usr/src/app/.next/static ./.next/static
# nextjs 사용자로 전환합니다.
USER nextjs
# 포트를 열어줍니다.
EXPOSE 3000
# 포트 환경변수를 설정합니다.
ENV PORT 3000
# 애플리케이션을 실행합니다.
CMD ["node", "server.js"]
```

## Nginx 설치

Nginx는 docker가 아닌 EC2 내부에 직접 설치했다.<br>
docker의 오버헤드가 없고, 설정을 직접 관리하고 조정할 수 있기 때문<br>
다음 명령어를 입력해 설치한다.

```bash
sudo apt-get update
sudo apt-get upgrade
sudo apt-get install nginx
```

22, 80, 443 포트를 사용하므로 열리지 않은 포트가 있다면 열어준다

```bash
sudo ufw allow {port_num}
sudo ufw status # 열린 포트 확인
```

그리고 설정 파일을 생성한다.

```bash
cd /etc/nginx/conf.d
sudo vim default.conf
```

> /etc/nginx/conf.d/default.conf

```docker
upstream front-dev {
    server localhost:3100;
}

upstream frontend {
    server localhost:3000;
}

upstream back-dev {
    server localhost:8100;
}

upstream backend {
    server localhost:8000;
}

server {
    server_name commitpixel.com;

    location /api {
        rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
    }

    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;

    }
    
        location /socket.io/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;

        proxy_pass http://localhost:3001;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
       
         #504
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
    }

    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/commitpixel.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/commitpixel.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    server_name dev.commitpixel.com;

    location /api {
        rewrite ^/api(/.*)$ $1 break;
        proxy_pass http://back-dev;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
    }

    location / {
        proxy_pass http://front-dev;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_http_version 1.1;
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
       
         #504
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        send_timeout 300s;

    }
    
    location /socket.io/ {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;

        proxy_pass http://localhost:3101;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_buffer_size          128k;
      	proxy_buffers              4 256k;
      	proxy_busy_buffers_size    256k;
       
         #504
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
    }

    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/commitpixel.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/commitpixel.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}


server {
    if ($host = commitpixel.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot
    
    if ($host = www.commitpixel.com) {
        return 301 https://$host$request_uri;
    }

    if ($host = k9a709.p.ssafy.io) {
        return 301 https://commitpixel.com$request_uri;
    }

    listen 80;
    server_name commitpixel.com k9a709.p.ssafy.io;
    return 404; # managed by Certbot
}

server {
    if ($host = dev.commitpixel.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name dev.commitpixel.com dev.k9a709.p.ssafy.io;
    return 404; # managed by Certbot
}

server {
    if ($host = k9a709.p.ssafy.io) {
        return 301 https://commitpixel.com$request_uri;
    }

    listen 443 ssl;
}

server {
    listen 80;
    server_name 3.38.210.9;

    location /nginx_status {
        stub_status on;
        allow 43.201.19.184; # prometheus EC2 address
        deny all;
    }
}


```

`다음 명령어를 입력하여 Certbot으로 https 인증 키를 받아야 한다.`

```
# snap을 이용하여 core 설치 -> snap을 최신 버전으로 유지하기 위해 설치
$ sudo snap install core

# core를 refresh 해준다.
$ sudo snap refresh core

# 기존에 잘못된 certbot이 설치되어있을 수도 있으니 삭제 해준다.
$ sudo apt remove certbot

# certbot 설치
$ sudo snap install --classic certbot

# 인증키를 받을 도메인을 선택한다.
# 모든 도메인을 인증받고 싶다면 그대로 enter, Y를 입력한다.
```

| name     | port | location |
| -------- | ---- | -------- |
| frontend | 3000 | /        |
| backend  | 8000 | /api     |

mapping되는 주소는 위의 표와 같다.
Domain은 commitpixel.com이고, www.commitpixel.com, k9a709.p.ssafy.io 모두 https로 자동 연결된다.

<br><br>

# 2. Jenkins 설정

Jenkins를 이용해서 빌드, docker 이미지 생성 및 배포를 자동화 할 수 있다.<br>

## Release

Release pipeline 코드는 다음과 같다.

> 전략

```
# 1. environment release 브랜치를 hooking 한다
# 2. stages
# 2-1. gitlab에서 release의 code를 workspace에 copy한다
# 2-2. release 빌드에 필요한 Dockerfile과 application.yml파일을 workspace에 복사한다.
# 2-3. 복사된 Dockerfile을 기반으로 image를 생성한다.
# 2-4. 생성한 image를 container로 만들어 데몬으로 실행한다.
# 2-5. 실행되지 않는 docker는 정리한다.
```

```docker
pipeline {
	agent any
	
	environment {
		gitlabBranch = "release"
	}
	
	stages {
		
				stage('Clone Repository') {
            steps {
                echo "Branch : ${env.gitlabBranch}"
                echo "Clone repository"
                git branch: "${env.gitlabBranch}", url: "https://lab.ssafy.com/s09-final/S09P31A709", credentialsId: 'gitlab_credential'
            }
        }
		
        stage("Set environment") {
            steps {
                echo "Copy require file to pipeline folder"
                
                // BACKEND
                // spring cloud config 
                sh 'cp /var/jenkins_home/util/back/cloudconfigapplication.yml /var/jenkins_home/workspace/release/backend/cloudconfig/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/msaconfig.yml /var/jenkins_home/workspace/release/backend/cloudconfig/src/main/resources/config/msaconfig.yml'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/cloudconfig/'
                // spring cloud Eureka
                sh 'cp /var/jenkins_home/util/back/eurekaapplication.yml /var/jenkins_home/workspace/release/backend/eureka/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/eureka/'
                // spring cloud apigateway
                sh 'cp /var/jenkins_home/util/back/apigatewayapplication.yml /var/jenkins_home/workspace/release/backend/apigateway/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/apigateway/'
                // MS
                sh 'cp /var/jenkins_home/util/back/authapplication.yml /var/jenkins_home/workspace/release/backend/authms/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/userapplication.yml /var/jenkins_home/workspace/release/backend/userms/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/pixelapplication.yml /var/jenkins_home/workspace/release/backend/pixelms/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/imageapplication.yml /var/jenkins_home/workspace/release/backend/imagems/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/rankapplication.yml /var/jenkins_home/workspace/release/backend/rankms/src/main/resources/application.yml'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/authms/'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/userms/'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/pixelms/'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/imagems/'
                sh 'cp /var/jenkins_home/util/back/Dockerfile /var/jenkins_home/workspace/release/backend/rankms/'
                
                //Flourish.java파일 release버전으로 바꾸기
                sh 'cp /var/jenkins_home/util/back/Flourish.java /var/jenkins_home/workspace/release/backend/rankms/src/main/java/com/ssafy/realrealfinal/rankms/db/document/Flourish.java'
                
                
                // FRONTEND
                sh 'cp /var/jenkins_home/util/front_dev/Dockerfile ./frontend/'
            }
        }
        
        stage('Docker build') {
            steps {
                echo "docker build"
                // BACKEND
                // spring cloud config 
                dir('/var/jenkins_home/workspace/release/backend/cloudconfig/') {
                    sh "docker build --build-arg APP_PORT=8080 -t cloudconfig:commitpixel ."
                }
                // spring cloud Eureka
                dir('/var/jenkins_home/workspace/release/backend/eureka/') {
                    sh "docker build --build-arg APP_PORT=8761 -t eureka:commitpixel ."
                }
                // spring cloud apigateway
                dir('/var/jenkins_home/workspace/release/backend/apigateway/') {
                    sh "docker build --build-arg APP_PORT=8000 -t apigateway:commitpixel ."
                }
                // MS
                dir('/var/jenkins_home/workspace/release/backend/authms/') {
                    sh "docker build --build-arg APP_PORT=8081 -t auth:commitpixel ."
                }
                dir('/var/jenkins_home/workspace/release/backend/userms/') {
                    sh "docker build --build-arg APP_PORT=8082 -t user:commitpixel ."
                }
                dir('/var/jenkins_home/workspace/release/backend/pixelms/') {
                    sh "docker build --build-arg APP_PORT=8083 -t pixel:commitpixel ."
                }
                dir('/var/jenkins_home/workspace/release/backend/imagems/') {
                    sh "docker build --build-arg APP_PORT=8084 -t image:commitpixel ."
                }
                dir('/var/jenkins_home/workspace/release/backend/rankms/') {
                    sh "docker build --build-arg APP_PORT=8085 -t rank:commitpixel ."
                }
                
                // FRONTEND
                dir('/var/jenkins_home/workspace/release/frontend/') {
                    sh "docker build -t frontend:commitpixel ."
                }
            }
            post {
                success {
                    echo "Success to build"
                }
                failure {
                    echo "Docker build failed. clear unused file"
                    sh "docker system prune -f"
                    error 'pipeline aborted'
                }
            }
        }
        
        stage('Docker up') {
            steps {
                echo "docker up"
                // BACKEND
                // spring cloud config 
                sh 'docker rm -f cloudconfig'
                sh "docker run -d --name cloudconfig -p 8080:8080 --network release -u root cloudconfig:commitpixel"
                // spring cloud Eureka
                sh 'docker rm -f eureka'
                sh "docker run -d --name eureka -p 8761:8761 --network release -u root eureka:commitpixel"
                // spring cloud apigateway
                sh 'docker rm -f apigateway'
                sh "docker run -d --name apigateway -p 8000:8000 --network release -u root apigateway:commitpixel"
                
                sleep(10)
                // MS
                sh 'docker rm -f auth'
                sh "docker run -d --name auth -p 8081:8081 --network release -u root auth:commitpixel"
                sh 'docker rm -f user'
                sh "docker run -d --name user -p 8082:8082 --network release -u root user:commitpixel"
                sh 'docker rm -f pixel'
                sh "docker run -d --name pixel -p 8083:8083 -p 3001:3001 --network release -u root pixel:commitpixel"
                sh 'docker rm -f rank'
                sh "docker run -d --name rank -p 8084:8084 --network release -u root rank:commitpixel"
                sh 'docker rm -f image'
                sh "docker run -d --name image -p 8085:8085 --network release -u root image:commitpixel"
                //Front
                sh 'docker rm -f front'
                sh "docker run -d --name front -p 3000:3000 --network release -u root frontend:commitpixel"
            }
        }
        
        
        stage('Docker clear') {
            steps{
                sh "docker system prune -f"
            }
        }
	}
}
```

<br><br>

# 외부 서비스

#### **AWS RDS**

- **서비스 설명**: Amazon Relational Database Service(AWS RDS)는 클라우드에서 관계형 데이터베이스를 쉽게 설정, 운영 및 확장할 수 있는 서비스
- **주요 특징**:
  - 다양한 데이터베이스 인스턴스 유형 지원
  - 자동 백업, 소프트웨어 패치, 자동 확장 등의 기능 제공
- **가입 방법**: AWS 계정을 생성한 후, AWS Management Console에서 RDS 서비스를 찾아 가입합니다.
- **사용 방법**: [AWS RDS Documentation](https://aws.amazon.com/rds/)

#### **AWS S3**

- **서비스 설명**: Amazon Simple Storage Service(Amazon S3)는 업계 최고 수준의 확장성, 데이터 가용성, 보안 및 성능을 제공하는 객체 스토리지 서비스
- **주요 특징**:
  - 높은 내구성과 가용성을 보장하는 객체 저장소
  - 데이터 보호 및 보안 기능
- **가입 방법**: AWS 계정을 생성한 후, AWS Management Console에서 S3 서비스를 찾아 가입합니다.
- **사용 방법**: [AWS S3 Documentation](https://aws.amazon.com/ko/s3/)

#### Atlas MongoDB

- **서비스 설명**: Atlas MongoDB는 클라우드 기반의 MongoDB 서비스로, 데이터베이스를 쉽고 빠르게 관리할 수 있도록 지원합니다. 클라우드 환경에서 MongoDB 인스턴스를 호스팅하며, 자동화된 백업, 확장성, 보안 기능을 제공합니다.
- **주요 특징**:
  - 클라우드 환경에서의 자동화된 백업 및 복구 기능
  - 쉬운 확장성 및 관리 편의성
  - 데이터 보안 및 암호화 옵션
- **가입 방법**: MongoDB 웹사이트에서 Atlas MongoDB 서비스에 가입하고, 관련 계정을 설정합니다.
- **사용 방법**: [Atlas MongoDB Documentation](https://www.mongodb.com/docs/atlas/)

#### **GITHUB API**

- **서비스 설명**: 사용자의 최근 7일간 커밋기록을 가져오기 위한 API
  커밋기록을 기반으로 픽셀 크레딧을 지급하기 위해 사용
- **사용 방법**: [GitHub API Documentation](https://docs.github.com/en/rest?apiVersion=2022-11-28)

#### **SOLVEDAC API**

- **서비스 설명**: 사용자의 백준 푼 문제수를 가져오기 위한 API
  푼 알고리즘 문제수를 기반으로 픽셀 크레딧을 지급하기 위해 사용
- **사용 방법**: [Solvedac Unofficial Documentation](https://solvedac.github.io/unofficial-documentation/#/)


#### Flourish

- **서비스 설명**: Flourish는 데이터 시각화 및 인터랙티브 스토리텔링을 위한 웹 기반 플랫폼입니다. 사용자는 복잡한 데이터를 쉽고 직관적으로 시각화할 수 있으며, 인터랙티브한 차트, 지도 및 데이터 스토리를 생성할 수 있습니다.
- **주요 특징**:
  - 사용하기 쉬운 드래그 앤 드롭 인터페이스
  - 다양한 시각화 템플릿과 사용자 정의 옵션
  - 데이터를 쉽게 가져오고 내보낼 수 있는 기능
- **가입 방법**: Flourish 웹사이트를 방문하여 계정을 생성하고, 가입 절차를 완료합니다.
- **사용 방법**: [Flourish Documentation](https://help.flourish.studio/)

<br><br>

# DB 덤프 파일 최신본

[DB 덤프 파일 최신본](files/commitPIXEL_db_dump.sql)

<br>

# 기능 시연

[README.md](../README.md#💻-주요-기능-미리보기)
